name: UnitTest

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  pytest-py3:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.x
          architecture: x64
      - name: Fetch Wenet
        uses: actions/checkout@v1
      - name: Checkout PR tip
        run: |
          set -eux
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # We are on a PR, so actions/checkout leaves us on a merge commit.
            # Check out the actual tip of the branch.
            git checkout ${{ github.event.pull_request.head.sha }}
          fi
          echo ::set-output name=commit_sha::$(git rev-parse HEAD)
        id: get_pr_tip
      - name: Run pytest
        run: |
          set -eux
          pip install pytest
          pytest --version
          export PYTHONPATH=$PYTHONPATH:$PWD && pytest -q
          if [ $? != 0 ]; then exit 1; fi

