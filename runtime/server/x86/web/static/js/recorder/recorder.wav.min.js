/*
录音
https://github.com/xiangyuecn/Recorder
src: recorder-core.js,engine/wav.js
*/
!function(u){"use strict";m.LM="2019-9-9 21:09:34";var l=function(){};function m(e){return new t(e)}function t(e){var t={type:"mp3",bitRate:16,sampleRate:16e3,bufferSize:4096,onProcess:l};for(var a in e)t[a]=e[a];this.set=t,this._S=9}m.IsOpen=function(){var e=m.Stream;if(e){var t=e.getTracks();if(0<t.length)return"live"==t[0].readyState}return!1},m.Support=function(){var e=u.AudioContext;if(e||(e=u.webkitAudioContext),!e)return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(m.Scope=t,m.Ctx&&"closed"!=m.Ctx.state||(m.Ctx=new e),!0)},m.SampleData=function(e,t,a,n){n||(n={});for(var r=n.index||0,o=n.offset||0,s=0,i=r;i<e.length;i++)s+=e[i].length;s=Math.max(0,s-Math.floor(o));var c=t/a;1<c?s=Math.floor(s/c):(c=1,a=t);for(var f=new Int16Array(s),p=0,u=e.length;r<u;r++){for(var l=e[r],v=(i=o,l.length);i<v;){var m=Math.floor(i),h=Math.ceil(i),d=i-m;f[p]=l[m]+(l[h]-l[m])*d,p++,i+=c}o=i-v}return{index:r,offset:o,sampleRate:a,data:f}},m.Sync={O:9,C:9},m.prototype=t.prototype={open:function(t,n){var a=this;t=t||l,n=n||l;var r=m.Sync,o=++r.O,s=r.C;a._O=o,a._SO=a._S;var i=function(){if(s!=r.C||!a._O){var e="open被取消";return o==r.O?a.close():e+="open被中断",n(e),!0}},c=function(){if(!1===u.isSecureContext)return n("无权录音(需https)"),1};if(m.IsOpen())t();else if(m.Support()){var e=function(e){m.Stream=e,i()||setTimeout(function(){i()||(m.IsOpen()?t():n("录音功能无效：无音频流"))},100)},f=function(e){var t=e.name||e.message||"";console.error(e);var a=/Permission|Allow/i.test(t);c()||n(a?"用户拒绝了录音权限":"无法录音："+t,a)},p=m.Scope.getUserMedia({audio:!0},e,f);p&&p.then&&p.then(e)[t&&"catch"](f)}else c()||n("此浏览器不支持录音")},close:function(e){e=e||l;var t=this;t._stop();var a=m.Sync,n=t._O;if(t._O=0,n!=a.O)return n&&console.warn("close被中断"),void e();a.C++;var r=m.Stream;if(r)for(var o=r.getTracks(),s=0;s<o.length;s++)o[s].stop();m.Stream=0,e()},mock:function(e,t){var a=this;return a._stop(),a.isMock=1,a.buffers=[e],a.recSize=e.length,a.srcSampleRate=t,a},envStart:function(e,t){var a=this,n=a.set;if(a.isMock=e?1:0,a.buffers=[],a.recSize=0,n.sampleRate=Math.min(t,n.sampleRate),a.srcSampleRate=t,a.engineCtx=0,a[n.type+"_start"]){var r=a.engineCtx=a[n.type+"_start"](n);r&&(r.pcmDatas=[],r.pcmSize=0)}},envIn:function(e,t){var a=this,n=a.set,r=a.engineCtx,o=e.length;a.recSize+=o;var s=a.buffers;s.push(e);var i,c=t/o;i=c<1251?Math.round(c/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(c/1e4)/Math.log(10)))));var f=a.srcSampleRate,p=a.recSize;if(r){var u=m.SampleData(s,f,n.sampleRate,r.chunkInfo);r.chunkInfo=u,r.pcmSize+=u.data.length,p=r.pcmSize,(s=r.pcmDatas).push(u.data),f=u.sampleRate,a[n.type+"_encode"](r,u.data)}var l=Math.round(p/f*1e3);n.onProcess(s,i,l,f)},start:function(){if(m.IsOpen()){console.log("["+Date.now()+"]Start");var e=this,t=(e.set,m.Ctx);e._stop(),e.state=0,e.envStart(0,t.sampleRate),"suspended"==t.state?t.resume().then(function(){console.log("ctx resume"),e._start()}):e._start()}else console.error("未open")},_start:function(){var i=this,e=i.set;if(i._SO&&i._SO+1!=i._S)console.warn("start被中断");else{i._SO=0;i.engineCtx;var t=m.Ctx,a=i.media=t.createMediaStreamSource(m.Stream),n=i.process=(t.createScriptProcessor||t.createJavaScriptNode).call(t,e.bufferSize,1,1);n.onaudioprocess=function(e){if(1==i.state){for(var t=e.inputBuffer.getChannelData(0),a=t.length,n=new Int16Array(a),r=0,o=0;o<a;o++){var s=Math.max(-1,Math.min(1,t[o]));s=s<0?32768*s:32767*s,n[o]=s,r+=Math.abs(s)}i.envIn(n,r)}},a.connect(n),n.connect(t.destination),i.state=1}},pause:function(e){this.state&&(this.state=e||2)},resume:function(){this.pause(1)},_stop:function(e){var t=this,a=t.set;t.isMock||t._S++,t.state&&(t.state=0,t.media.disconnect(),t.process.disconnect()),!e&&t[a.type+"_stop"]&&(t[a.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(a,t,e){console.log("["+Date.now()+"]Stop");var n,r=this,o=r.set,s=function(){r._stop(),e&&r.close()},i=function(e){t&&t(e),s()},c=function(e,t){console.log("["+Date.now()+"]End",t,"编码耗时:"+(Date.now()-n),e),e.size<Math.max(100,t/2)?i("生成的"+o.type+"无效"):(a&&a(e,t),s())};if(!r.isMock){if(!r.state)return void i("未开始录音");r._stop(!0)}var f=r.recSize;if(f)if(r[o.type]){var p=r.engineCtx;if(r[o.type+"_complete"]&&p){p.pcmDatas;var u=Math.round(p.pcmSize/o.sampleRate*1e3);return n=Date.now(),void r[o.type+"_complete"](p,function(e){c(e,u)},i)}n=Date.now();var l=m.SampleData(r.buffers,r.srcSampleRate,o.sampleRate);o.sampleRate=l.sampleRate;var v=l.data;u=Math.round(v.length/o.sampleRate*1e3);console.log("采样"+f+"->"+v.length+" 花:"+(Date.now()-n)+"ms"),setTimeout(function(){n=Date.now(),r[o.type](v,function(e){c(e,u)},function(e){i(e)})})}else i("未加载"+o.type+"编码器");else i("未采集到录音")}},u.Recorder=m}(window),function(){"use strict";Recorder.prototype.enc_wav={stable:!0,testmsg:"比特率取值范围8位、16位"},Recorder.prototype.wav=function(e,t,a){var n=this.set,r=e.length,o=n.sampleRate,s=8==n.bitRate?8:16,i=r*(s/8),c=new ArrayBuffer(44+i),f=new DataView(c),p=0,u=function(e){for(var t=0;t<e.length;t++,p++)f.setUint8(p,e.charCodeAt(t))},l=function(e){f.setUint16(p,e,!0),p+=2},v=function(e){f.setUint32(p,e,!0),p+=4};if(u("RIFF"),v(36+i),u("WAVE"),u("fmt "),v(16),l(1),l(1),v(o),v(o*(s/8)),l(s/8),l(s),u("data"),v(i),8==s)for(var m=0;m<r;m++,p++){var h=128+(e[m]>>8);f.setInt8(p,h,!0)}else for(m=0;m<r;m++,p+=2)f.setInt16(p,e[m],!0);t(new Blob([f.buffer],{type:"audio/wav"}))}}();